generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  firebaseUid     String?   @unique
  passwordHash    String?
  name            String
  role            Role      @default(STUDENT)
  avatar          String?
  bio           String?
  isActive        Boolean   @default(true)
  isEmailVerified Boolean   @default(false)
  lastLoginAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  courses        Course[]         @relation("InstructorCourses")
  enrollments    Enrollment[]
  reviews        Review[]
  transactions   Transaction[]
  wishlist       Wishlist[]
  lessonProgress LessonProgress[]
  sessions       Session[]

  @@index([email])
  @@index([firebaseUid])
  @@index([role, isActive])
}

model Session {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Device Information
  deviceName  String
  deviceType  String   // "desktop" | "mobile" | "tablet"
  browser     String
  os          String?
  
  // Location & Security
  location    String?
  ipAddress   String
  
  // Token Management
  tokenHash   String   @unique
  expiresAt   DateTime
  
  // Timestamps
  createdAt   DateTime @default(now())
  lastActive  DateTime @default(now())
  revokedAt   DateTime?
  
  @@index([userId])
  @@index([userId, expiresAt])
  @@index([tokenHash])
  @@index([lastActive])
}

model Resource {
  id          String   @id @default(uuid())
  title       String
  description String?
  type        String
  url         String
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([type])
}

enum Role {
  ADMIN
  INSTRUCTOR
  STUDENT
}

model Course {
  id              String    @id @default(uuid())
  title           String
  slug            String    @unique
  description     String    @db.Text
  thumbnail       String?
  videoUrl        String?
  price           Decimal   @db.Decimal(10, 2)
  level           Level
  category      String
  tags          String[]
  duration      String?
  status        Status    @default(DRAFT)
  averageRating   Decimal?  @db.Decimal(3, 2)
  totalRatings    Int       @default(0)
  enrollmentCount Int       @default(0)
  
  instructorId   String
  instructor     User      @relation("InstructorCourses", fields: [instructorId], references: [id])
  instructorName String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  lessons      Lesson[]
  enrollments  Enrollment[]
  reviews      Review[]
  transactions Transaction[]
  wishlistedBy Wishlist[]

  @@index([status, publishedAt])
  @@index([category, status])
  @@index([instructorId])
  @@index([slug])
  @@index([averageRating])
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ALL_LEVELS
}

enum Status {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  description String?
  icon        String?
  order       Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([slug])
  @@index([order, isActive])
}

model Wishlist {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId  String
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Lesson {
  id            String   @id @default(uuid())
  title         String
  slug          String
  description   String?  @db.Text
  videoUrl      String?
  content       String?  @db.Text
  duration      Int
  order         Int
  isFree        Boolean  @default(false)
  isPublished   Boolean  @default(true)
  attachments   Json?
  videoProvider String?

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  progress LessonProgress[]

  @@unique([courseId, slug])
  @@index([courseId, order])
}

model LessonProgress {
  id              String   @id @default(uuid())
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  lessonId        String
  lesson          Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  
  courseId        String
  
  isCompleted     Boolean  @default(false)
  watchedDuration Int      @default(0)
  lastPosition    Int      @default(0)
  completedAt     DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lessonId])
  @@index([userId, courseId])
  @@index([lessonId])
  @@index([userId, courseId, isCompleted])
}

model Enrollment {
  id               String   @id @default(uuid())
  progress         Int      @default(0)
  completedLessons String[]
  completedAt      DateTime?
  certificateUrl   String?
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  enrolledAt     DateTime @default(now())
  lastAccessedAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([userId, lastAccessedAt])
  @@index([courseId])
  @@index([userId, progress])
}

model Review {
  id                 String   @id @default(uuid())
  rating             Int
  comment            String?  @db.Text
  isVerifiedPurchase Boolean  @default(false)
  isPublished        Boolean  @default(true)
  helpfulCount       Int      @default(0)
  
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, courseId])
  @@index([courseId, rating])
  @@index([courseId, createdAt])
  @@index([isPublished, createdAt])
}

model Transaction {
  id            String   @id @default(uuid())
  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("USD")
  status        TxStatus
  provider      String
  externalId    String?
  paymentUrl    String?
  failureReason String?
  metadata      Json?
  refundedAt    DateTime?
  refundAmount  Decimal? @db.Decimal(10, 2)
  ipAddress     String?

  userId String
  user   User   @relation(fields: [userId], references: [id])
  
  courseId String
  course   Course @relation(fields: [courseId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([externalId])
  @@index([courseId])
}

enum TxStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model Coupon {
  id              String   @id @default(uuid())
  code            String   @unique
  discountPercent Int?
  discountAmount  Decimal? @db.Decimal(10, 2)
  maxUses         Int?
  usedCount       Int      @default(0)
  validFrom       DateTime
  validUntil      DateTime
  isActive        Boolean  @default(true)
  courseIds       String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([code, isActive])
  @@index([validFrom, validUntil, isActive])
}
